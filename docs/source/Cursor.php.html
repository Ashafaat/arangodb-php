<html>
    <head>
        <script
            type="text/javascript"
            src="../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php

/**
 * ArangoDB PHP client: result set cursor
 *
 * @package   triagens\ArangoDb
 * @author    Jan Steemann
 * @copyright Copyright 2012, triagens GmbH, Cologne, Germany
 */

namespace triagens\ArangoDb;

/**
 * Provides access to the results of a read-only statement
 *
 * The cursor might not contain all results in the beginning.
 *
 * If the result set is too big to be transferred in one go, the
 * cursor might issue additional HTTP requests to fetch the
 * remaining results from the server.
 *
 * @package triagens\ArangoDb
 */
class Cursor implements
    \Iterator
{
    /**
     * The connection object
     *
     * @var Connection
     */
    private $_connection;

    /**
     * Cursor options
     *
     * @var array
     */
    private $_options;

    /**
     * The result set
     *
     * @var array
     */
    private $_result;

    /**
     * &quot;has more&quot; indicator - if true, the server has more results
     *
     * @var bool
     */
    private $_hasMore;

    /**
     * cursor id - might be NULL if cursor does not have an id
     *
     * @var mixed
     */
    private $_id;

    /**
     * current position in result set iteration (zero-based)
     *
     * @var int
     */
    private $_position;

    /**
     * total length of result set (in number of documents)
     *
     * @var int
     */
    private $_length;


    /**
     * result entry for cursor id
     */
    const ENTRY_ID = 'id';

    /**
     * result entry for &quot;hasMore&quot; flag
     */
    const ENTRY_HASMORE = 'hasMore';

    /**
     * result entry for result documents
     */
    const ENTRY_RESULT = 'result';

    /**
     * sanitize option entry
     */
    const ENTRY_SANITIZE = '_sanitize';

    /**
     * &quot;flat&quot; option entry (will treat the results as a simple array, not documents)
     */
    const ENTRY_FLAT = '_flat';

    /**
     * Initialise the cursor with the first results and some metadata
     *
     * @param Connection $connection - connection to be used
     * @param array      $data       - initial result data as returned by the server
     * @param array      $options    - cursor options
     *
     * @return Cursor
     */
    public function __construct(Connection $connection, array $data, array $options)
    {
        $this-&gt;_connection = $connection;
        $this-&gt;data        = $data;
        $this-&gt;_id         = null;
        if (isset($data[self::ENTRY_ID])) {
            $this-&gt;_id = $data[self::ENTRY_ID];
        }

        // attribute must be there
        assert(isset($data[self::ENTRY_HASMORE]));
        $this-&gt;_hasMore = (bool) $data[self::ENTRY_HASMORE];

        $options['isNew'] = false;
        $this-&gt;_options   = $options;
        $this-&gt;_result    = array();
        $this-&gt;add((array) $data[self::ENTRY_RESULT]);
        $this-&gt;updateLength();

        $this-&gt;rewind();
    }


    /**
     * Explicitly delete the cursor
     *
     * This might issue an HTTP DELETE request to inform the server about
     * the deletion.
     *
     * @throws Exception
     * @return bool - true if the server acknowledged the deletion request, false otherwise
     */
    public function delete()
    {
        if ($this-&gt;_id) {
            try {
                $this-&gt;_connection-&gt;delete(Urls::URL_CURSOR . '/' . $this-&gt;_id);

                return true;
            } catch (Exception $e) {
            }
        }

        return false;
    }


    /**
     * Get the total number of results in the cursor
     *
     * This might issue additional HTTP requests to fetch any outstanding
     * results from the server
     *
     * @throws Exception
     * @return int - total number of results
     */
    public function getCount()
    {
        while ($this-&gt;_hasMore) {
            $this-&gt;fetchOutstanding();
        }

        return $this-&gt;_length;
    }


    /**
     * Get all results as an array
     *
     * This might issue additional HTTP requests to fetch any outstanding
     * results from the server
     *
     * @throws Exception
     * @return array - an array of all results
     */
    public function getAll()
    {
        while ($this-&gt;_hasMore) {
            $this-&gt;fetchOutstanding();
        }

        return $this-&gt;_result;
    }


    /**
     * Rewind the cursor, necessary for Iterator
     *
     * @return void
     */
    public function rewind()
    {
        $this-&gt;_position = 0;
    }


    /**
     * Return the current result row, necessary for Iterator
     *
     * @return array - the current result row as an assoc array
     */
    public function current()
    {
        return $this-&gt;_result[$this-&gt;_position];
    }


    /**
     * Return the index of the current result row, necessary for Iterator
     *
     * @return int - the current result row index
     */
    public function key()
    {
        return $this-&gt;_position;
    }


    /**
     * Advance the cursor, necessary for Iterator
     *
     * @return void
     */
    public function next()
    {
        ++$this-&gt;_position;
    }


    /**
     * Check if cursor can be advanced further, necessary for Iterator
     *
     * This might issue additional HTTP requests to fetch any outstanding
     * results from the server
     *
     * @throws Exception
     * @return bool - true if the cursor can be advanced further, false if cursor is at end
     */
    public function valid()
    {
        if ($this-&gt;_position &lt;= $this-&gt;_length - 1) {
            // we have more results than the current position is
            return true;
        }

        if (!$this-&gt;_hasMore || !$this-&gt;_id) {
            // we don't have more results, but the cursor is exhausted
            return false;
        }

        // need to fetch additional results from the server
        $this-&gt;fetchOutstanding();

        return ($this-&gt;_position &lt;= $this-&gt;_length - 1);
    }


    /**
     * Create an array of results from the input array
     *
     * @param array $data - incoming result
     *
     * @return void
     */
    private function add(array $data)
    {
        foreach ($this-&gt;sanitize($data) as $row) {

            if ((isset($this-&gt;_options[self::ENTRY_FLAT]) &amp;&amp; $this-&gt;_options[self::ENTRY_FLAT]) || !is_array($row)) {
                $this-&gt;addFlatFromArray($row);
            } else {
                if (!isset($this-&gt;_options['objectType'])) {
                    $this-&gt;addDocumentsFromArray($row);
                } else {

                    switch ($this-&gt;_options['objectType']) {
                        case 'edge' :
                            $this-&gt;addEdgesFromArray($row);

                            break;
                        case 'vertex' :
                            $this-&gt;addVerticesFromArray($row);

                            break;
                        default :
                            $this-&gt;addDocumentsFromArray($row);

                            break;
                    }
                }
            }
        }
    }


    /**
     * Create an array of results from the input array
     *
     * @param array $data - array of incoming results
     *
     * @return void
     */
    private function addFlatFromArray($data)
    {
        $this-&gt;_result[] = $data;
    }


    /**
     * Create an array of documents from the input array
     *
     * @param array $data    - array of incoming &quot;document&quot; arrays
     *
     * @return void
     */
    private function addDocumentsFromArray(array $data)
    {
        $this-&gt;_result[] = Document::createFromArray($data, $this-&gt;_options);
    }


    /**
     * Create an array of Edges from the input array
     *
     * @param array $data    - array of incoming &quot;edge&quot; arrays
     *
     * @return void
     */
    private function addEdgesFromArray(array $data)
    {
        $this-&gt;_result[] = Edge::createFromArray($data, $this-&gt;_options);
    }


    /**
     * Create an array of Vertex from the input array
     *
     * @param array $data    - array of incoming &quot;vertex&quot; arrays
     *
     * @return void
     */
    private function addVerticesFromArray(array $data)
    {
        $this-&gt;_result[] = Vertex::createFromArray($data, $this-&gt;_options);
    }


    /**
     * Sanitize the result set rows
     *
     * This will remove the _id and _rev attributes from the results if the
     * &quot;sanitize&quot; option is set
     *
     * @param array $rows - array of rows to be sanitized
     *
     * @return array - sanitized rows
     */
    private function sanitize(array $rows)
    {
        if (isset($this-&gt;_options[self::ENTRY_SANITIZE]) and $this-&gt;_options[self::ENTRY_SANITIZE]) {
            foreach ($rows as $key =&gt; $value) {

                if (is_array($value) &amp;&amp; isset($value[Document::ENTRY_ID])) {
                    unset($rows[$key][Document::ENTRY_ID]);
                }

                if (is_array($value) &amp;&amp; isset($value[Document::ENTRY_REV])) {
                    unset($rows[$key][Document::ENTRY_REV]);
                }
            }
        }

        return $rows;
    }


    /**
     * Fetch outstanding results from the server
     *
     * @throws Exception
     * @return void
     */
    private function fetchOutstanding()
    {
        // continuation
        $response = $this-&gt;_connection-&gt;put(Urls::URL_CURSOR . &quot;/&quot; . $this-&gt;_id, '');
        $data     = $response-&gt;getJson();

        $this-&gt;_hasMore = (bool) $data[self::ENTRY_HASMORE];
        $this-&gt;add($data[self::ENTRY_RESULT]);

        if (!$this-&gt;_hasMore) {
            // we have fetch the complete result set and can unset the id now
            $this-&gt;_id = null;
        }

        $this-&gt;updateLength();
    }


    /**
     * Set the length of the (fetched) result set
     *
     * @return void
     */
    private function updateLength()
    {
        $this-&gt;_length = count($this-&gt;_result);
    }


    /**
     * Get MetaData of the current cursor
     *
     * @return array
     */
    public function getMetadata()
    {
        return $this-&gt;data;
    }
}
</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all()
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>